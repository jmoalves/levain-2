name: Test - e2e

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Nightly tag to test (default: latest nightly)"
                required: false
    schedule:
        - cron: "0 6 * * SUN"

permissions:
    contents: read

jobs:
    resolve-tag:
        runs-on: ubuntu-latest
        outputs:
            tag: ${{ steps.resolve.outputs.tag }}
        steps:
            - name: Resolve nightly tag
              id: resolve
              uses: actions/github-script@v7
              env:
                  TAG_INPUT: ${{ github.event.inputs.tag }}
              with:
                  script: |
                      const inputTag = process.env.TAG_INPUT;
                      if (inputTag) {
                        core.setOutput("tag", inputTag);
                        return;
                      }

                      const releases = await github.paginate(
                        github.rest.repos.listReleases,
                        { owner: context.repo.owner, repo: context.repo.repo, per_page: 100 }
                      );

                      const nightlies = releases
                        .filter(release => release.prerelease && release.tag_name.startsWith("nightly-"))
                        .sort((a, b) => new Date(a.published_at) - new Date(b.published_at));

                      if (nightlies.length === 0) {
                        core.setFailed("No nightly releases found.");
                        return;
                      }

                      core.setOutput("tag", nightlies[nightlies.length - 1].tag_name);

    e2e-binary-windows:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: binary
            runs-on: windows-latest
            script-name: install-windows.ps1
            ignore-file: e2e/ignore-windows.txt

    e2e-binary-linux:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: binary
            runs-on: ubuntu-latest
            script-name: install-linux.sh
            ignore-file: e2e/ignore-linux.txt

    e2e-binary-macos:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: binary
            runs-on: macos-latest
            script-name: install-macos.sh
            ignore-file: e2e/ignore-macos.txt

    e2e-jar-windows:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: jar
            runs-on: windows-latest
            script-name: install-windows.ps1
            ignore-file: e2e/ignore-windows.txt

    e2e-jar-linux:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: jar
            runs-on: ubuntu-latest
            script-name: install-linux.sh
            ignore-file: e2e/ignore-linux.txt

    e2e-jar-macos:
        needs: resolve-tag
        uses: ./.github/workflows/reusable-e2e.yml
        with:
            tag: ${{ needs.resolve-tag.outputs.tag }}
            test-mode: jar
            runs-on: macos-latest
            script-name: install-macos.sh
            ignore-file: e2e/ignore-macos.txt
