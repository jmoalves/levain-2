name: Reusable E2E Test

on:
    workflow_call:
        inputs:
            tag:
                description: "Release tag to test"
                required: true
                type: string
            test-mode:
                description: "Test mode: binary or jar"
                required: true
                type: string
            runs-on:
                description: "Runner OS"
                required: true
                type: string
            script-name:
                description: "Install script asset name in release"
                required: true
                type: string
            ignore-file:
                description: "Recipe ignore file path"
                required: true
                type: string

jobs:
    e2e-test:
        name: E2E ${{ inputs.test-mode }} (${{ inputs.runs-on }})
        runs-on: ${{ inputs.runs-on }}
        timeout-minutes: 180

        steps:
            - name: Checkout e2e ignore lists only
              uses: actions/checkout@v4
              with:
                  sparse-checkout: |
                      e2e/ignore-linux.txt
                      e2e/ignore-macos.txt
                      e2e/ignore-windows.txt
                  sparse-checkout-cone-mode: false

            - name: Set up JDK 25 (JAR mode only)
              if: inputs.test-mode == 'jar'
              uses: actions/setup-java@v4
              with:
                  java-version: "25"
                  distribution: "semeru"

            - name: Download install script (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  $tag = "${{ inputs.tag }}"
                  $repo = "${{ github.repository }}"
                  $url = "https://github.com/$repo/releases/download/$tag/${{ inputs.script-name }}"
                  for ($i = 1; $i -le 3; $i++) {
                    try {
                      Invoke-WebRequest -Uri $url -OutFile "${{ inputs.script-name }}" -UseBasicParsing
                      break
                    } catch {
                      if ($i -eq 3) { throw }
                      Start-Sleep -Seconds (2 * $i)
                    }
                  }

            - name: Download install script (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  tag="${{ inputs.tag }}"
                  repo="${{ github.repository }}"
                  curl --retry 3 --retry-delay 2 --retry-all-errors -fsSL \
                    -o "${{ inputs.script-name }}" \
                    "https://github.com/${repo}/releases/download/${tag}/${{ inputs.script-name }}"
                  chmod +x "${{ inputs.script-name }}"

            - name: Install Levain (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  $tag = "${{ inputs.tag }}"
                  $mode = "${{ inputs.test-mode }}"
                  $flag = if ($mode -eq "binary") { "-Binary" } else { "-Jar" }
                  $scriptPath = Join-Path $PWD "${{ inputs.script-name }}"
                  Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue
                  & pwsh -NoProfile -ExecutionPolicy Bypass -File $scriptPath -Tag $tag $flag -InstallDir "$HOME\levain" -AddToPath

            - name: Install Levain (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  set -euo pipefail
                  tag="${{ inputs.tag }}"
                  mode="${{ inputs.test-mode }}"
                  ./${{ inputs.script-name }} --tag "$tag" --$mode --install-dir "$HOME/levain" --add-to-path

            - name: Configure levain-pkgs repository (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  try {
                    levain config repo add https://github.com/jmoalves/levain-pkgs
                  } catch {
                    $repos = levain config repo list | Out-String
                    if ($repos -notmatch '(?m)https://github.com/jmoalves/levain-pkgs' -and $repos -notmatch '(?m)^\s*levain-pkgs\b') {
                      throw
                    }
                  }

            - name: Configure levain-pkgs repository (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  set -euo pipefail
                  if ! levain config repo add https://github.com/jmoalves/levain-pkgs; then
                    if ! levain config repo list | grep -Eq 'https://github.com/jmoalves/levain-pkgs|^\s*levain-pkgs\b'; then
                      exit 1
                    fi
                  fi

            - name: Install all recipes (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  $ignoreFile = "${{ inputs.ignore-file }}"
                  $ignore = @()
                  if (Test-Path $ignoreFile) {
                    $ignore = Get-Content $ignoreFile | ForEach-Object { $_.Trim() } | Where-Object { $_ -and -not $_.StartsWith("#") }
                  }

                  $recipes = levain list | ForEach-Object {
                    if ($_ -match '^\s*-\s*([A-Za-z0-9._-]+)') {
                      $matches[1]
                    }
                  }
                  $failed = @()
                  $batch = @()

                  function Install-Batch($items) {
                    if ($items.Count -eq 0) { return }
                    levain install @items
                    if ($LASTEXITCODE -ne 0) {
                      foreach ($pkg in $items) {
                        levain install $pkg
                        if ($LASTEXITCODE -ne 0) {
                          $script:failed += $pkg
                        }
                      }
                    }
                  }

                  foreach ($recipe in $recipes) {
                    if ($ignore -contains $recipe) { continue }
                    $batch += $recipe
                    if ($batch.Count -ge 10) {
                      Install-Batch $batch
                      $batch = @()
                    }
                  }

                  Install-Batch $batch

                  if ($failed.Count -gt 0) {
                    Write-Error ("Failed recipes: {0}" -f ($failed -join ", "))
                    exit 1
                  }

            - name: Install all recipes (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  set -euo pipefail

                  ignore_file="${{ inputs.ignore-file }}"
                  mapfile -t recipes < <(levain list \
                    | sed -n 's/^[[:space:]]*-[[:space:]]*\([^[:space:]].*\)$/\1/p' \
                    | awk '{print $1}' || true)

                  failed=()

                  install_batch() {
                    if levain install "$@"; then
                      return
                    fi
                    for pkg in "$@"; do
                      if ! levain install "$pkg"; then
                        failed+=("$pkg")
                      fi
                    done
                  }

                  batch=()
                  for recipe in "${recipes[@]}"; do
                    if [[ -f "$ignore_file" ]] && grep -qx "$recipe" "$ignore_file"; then
                      continue
                    fi
                    batch+=("$recipe")
                    if [[ ${#batch[@]} -ge 10 ]]; then
                      install_batch "${batch[@]}"
                      batch=()
                    fi
                  done

                  if [[ ${#batch[@]} -gt 0 ]]; then
                    install_batch "${batch[@]}"
                  fi

                  if [[ ${#failed[@]} -gt 0 ]]; then
                    echo "Failed recipes: ${failed[*]}"
                    exit 1
                  fi
