name: Nightly Build

on:
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    check-changes:
        name: Check for Changes
        runs-on: ubuntu-latest
        outputs:
            has-changes: ${{ steps.check.outputs.has-changes }}
            last-nightly-tag: ${{ steps.check.outputs.last-nightly-tag }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for changes since last nightly
              id: check
              run: |
                  # Find the most recent nightly tag
                  LAST_NIGHTLY=$(git tag -l 'nightly-*' | sort -V | tail -1)
                  echo "last-nightly-tag=$LAST_NIGHTLY" >> $GITHUB_OUTPUT

                  if [ -z "$LAST_NIGHTLY" ]; then
                    echo "has-changes=true" >> $GITHUB_OUTPUT
                    echo "No previous nightly found, will build"
                  else
                    # Check if there are commits since the last nightly tag
                    COMMIT_COUNT=$(git rev-list --count $LAST_NIGHTLY..HEAD)
                    if [ $COMMIT_COUNT -gt 0 ]; then
                      echo "has-changes=true" >> $GITHUB_OUTPUT
                      echo "Found $COMMIT_COUNT commits since $LAST_NIGHTLY, will build"
                    else
                      echo "has-changes=false" >> $GITHUB_OUTPUT
                      echo "No new commits since $LAST_NIGHTLY, skipping build"
                    fi
                  fi

    build-nightly:
        name: Build Nightly JAR
        needs: check-changes
        if: needs.check-changes.outputs.has-changes == 'true'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 25
              uses: actions/setup-java@v4
              with:
                  java-version: "25"
                  distribution: "semeru"
                  cache: maven

            - name: Build and test with Maven
              run: mvn -B clean test package -DskipTests
              env:
                  MAVEN_OPTS: "-Dnet.bytebuddy.experimental=true -XX:+EnableDynamicAgentLoading"

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: target/surefire-reports/
                  retention-days: 1

            - name: Create nightly release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Create tag and release
                  DATE=$(date -u +'%Y%m%d')
                  TAG="nightly-$DATE"

                  # Check if tag already exists (in case of multiple runs same day)
                  if git rev-parse "$TAG" >/dev/null 2>&1; then
                    echo "Tag $TAG already exists, using timestamp variant"
                    TAG="nightly-$DATE-$(date -u +'%H%M%S')"
                  fi

                  git tag "$TAG"
                  git push origin "$TAG"

                  # Create release with the JAR
                  gh release create "$TAG" \
                    --title "Nightly Build $DATE" \
                    --notes "Nightly build from commit $(git rev-parse --short HEAD)" \
                    --prerelease \
                    target/levain.jar

    cleanup-old-nightlies:
        name: Cleanup Old Nightly Releases
        needs: build-nightly
        if: needs.check-changes.outputs.has-changes == 'true'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Delete releases older than 7 days
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  CUTOFF_DATE=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

                  # Get all nightly releases
                  gh release list --limit 100 | grep "nightly-" | while read -r line; do
                    RELEASE_NAME=$(echo "$line" | awk '{print $1}')
                    RELEASE_DATE=$(echo "$line" | awk '{print $NF " " $(NF-1) " " $(NF-2)}' | xargs -I {} date -d "{}" -u +'%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || echo "$CUTOFF_DATE")
                    
                    # Simple date comparison
                    if [[ "$RELEASE_DATE" < "$CUTOFF_DATE" ]]; then
                      echo "Deleting old nightly release: $RELEASE_NAME"
                      gh release delete "$RELEASE_NAME" --yes
                    else
                      echo "Keeping release: $RELEASE_NAME (date: $RELEASE_DATE)"
                    fi
                  done
