name: Cleanup Old Workflow Runs

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to keep'
        required: false
        default: '5'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: Delete old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          const days = ${{ github.event.inputs.days || 5 }};
          const daysInMillis = days * 24 * 60 * 60 * 1000;
          const now = Date.now();
          const cutoffDate = new Date(now - daysInMillis);
          
          console.log(`Deleting workflow runs older than ${days} days (before ${cutoffDate.toISOString()})`);
          
          // Get all workflows
          const workflows = await github.rest.actions.listRepoWorkflows({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          let deletedCount = 0;
          
          for (const workflow of workflows.data.workflows) {
            console.log(`\nChecking workflow: ${workflow.name} (${workflow.id})`);
            
            // Get workflow runs for this workflow
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.id,
              per_page: 100,
            });
            
            for (const run of runs.data.workflow_runs) {
              const runDate = new Date(run.created_at);
              
              if (runDate < cutoffDate) {
                console.log(`  Deleting run #${run.run_number} from ${run.created_at} (${run.status})`);
                
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                  });
                  deletedCount++;
                } catch (error) {
                  console.log(`  Failed to delete run #${run.run_number}: ${error.message}`);
                }
              }
            }
          }
          
          console.log(`\nTotal runs deleted: ${deletedCount}`);
